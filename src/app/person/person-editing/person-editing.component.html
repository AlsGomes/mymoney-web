<div class="container">
    <form name="form" ngForm #form="ngForm" (ngSubmit)="save(form)">
        <div class="grid">
            <div class="col-12">
                <h1>{{editingCode ? "Edição de" : "Nova"}} Pessoa</h1>
            </div>

            <div class="col-12 p-fluid">
                <label>Nome</label>
                <input pInputText type="text" name="name" [(ngModel)]="person.name" #name="ngModel" [required]="true"
                    [minlength]="5">

                <p-message *ngIf="name.hasError('required') && name.touched" text="Nome é obrigatório" severity="error">
                </p-message>

                <p-message *ngIf="name.hasError('minlength') && name.touched"
                    text="Mínimo de {{name.errors?.['minlength'].requiredLength}} caracteres" severity="error">
                </p-message>
            </div>

            <div class="col-12 md:col-9 p-fluid">
                <label>Logradouro</label>
                <input pInputText type="text" name="street" #street="ngModel" [(ngModel)]="addressStreet">
            </div>

            <div class="col-12 md:col-3 p-fluid">
                <label>Número</label>
                <input pInputText type="text" name="num" #num="ngModel" [(ngModel)]="addressNum">
            </div>

            <div class="col-12 md:col-4 p-fluid">
                <label>Complemento</label>
                <input pInputText type="text" name="complement" #complement="ngModel" [(ngModel)]="addressComplement">
            </div>

            <div class="col-12 md:col-4 p-fluid">
                <label>Bairro</label>
                <input pInputText type="text" name="district" #district="ngModel" [(ngModel)]="addressDistrict">
            </div>

            <div class="col-12 md:col-4 p-fluid">
                <label>CEP</label>
                <p-inputMask mask="99999-999" name="postalCode" #postalCode="ngModel" [(ngModel)]="addressPostalCode">
                </p-inputMask>
            </div>

            <div class="col-12 md:col-6 p-fluid">
                <label>Cidade</label>
                <input pInputText type="text" name="city" #city="ngModel" [(ngModel)]="addressCity">
            </div>

            <div class="col-12 md:col-6 p-fluid">
                <label>Estado</label>
                <input pInputText type="text" name="state" #state="ngModel" [(ngModel)]="addressState">
            </div>

            <div class="col-12">
                <p-panel header="Contatos">
                    <div class="grid">
                        <div class="col-12">
                            <button 
                                label="Novo" 
                                type="button"
                                icon="pi pi-plus"                                 
                                class="p-button-text p-button-raised p-button-secondary" 
                                (click)="showContactModal(formContact)"
                                pButton>
                            </button>
                        </div>
                        <div class="col-12">
                            <p-table 
                                [value]="personContacts"
                                [responsive]="true">

                                <ng-template pTemplate="header">
                                    <tr>
                                        <th>Nome</th>
                                        <th>E-mail</th>
                                        <th>Telefone</th>
                                        <th class="col-actions"></th>
                                    </tr>
                                </ng-template>
                                <ng-template pTemplate="body" let-contact let-i="rowIndex">
                                    <tr>
                                        <td>{{contact.name}}</td>
                                        <td>{{contact.email}}</td>
                                        <td>{{contact.telephone}}</td>
                                        <td class="col-actions">
                                            <button
                                                pTooltip="Editar" 
                                                tooltipPosition="top"
                                                pButton 
                                                icon="pi pi-pencil"
                                                type="button"
                                                (click)="updateContact(contact, i, formContact)">
                                            </button>

                                            <button
                                                pTooltip="Excluir" 
                                                tooltipPosition="top"
                                                pButton 
                                                type="button"
                                                icon="pi pi-trash"
                                                (click)="removeContact(i)">
                                            </button>
                                        </td>
                                    </tr>
                                </ng-template>
                                <ng-template pTemplate="emptymessage">
                                    <tr>
                                        <td colspan="4">
                                            Nenhum contato cadastrado
                                        </td>
                                    </tr>
                                </ng-template>
                            </p-table> 
                        </div>
                    </div>
                </p-panel>
            </div>

            <div class="col-12">
                <button pButton type="submit" [disabled]="form.invalid">Salvar</button>
                <button pButton type="button" class="p-button-info" (click)="new(form)">Novo</button>
                <a [routerLink]="['/persons']">Voltar para a pesquisa</a>
            </div>
        </div>
    </form>
</div>

<p-dialog [header]="updatingContact ? 'Atualizando Contato' : 'Novo Contato'" [(visible)]="showingContactModal" [modal]="true">
    <form #formContact="ngForm" (ngSubmit)="saveNewContact(formContact)">
        <div class="col-12 p-fluid">
            <label>Nome</label>
    
            <input 
                name="newContactName"
                pInputText 
                type="text" 
                required 
                [(ngModel)]="newContactInfo.name" 
                #newContactName="ngModel"/>
    
            <p-message 
                *ngIf="newContactName.hasError('required') && newContactName.touched"
                text="Nome é obrigatório"
                severity="error">
            </p-message>
        </div>
    
        <div class="col-12 p-fluid">
            <label>E-mail</label>
    
            <input 
                name="newContactEmail"
                pInputText 
                type="email" 
                required email 
                [(ngModel)]="newContactInfo.email" 
                #newContactEmail="ngModel"/>
    
            <p-message 
                *ngIf="newContactEmail.hasError('required') && newContactEmail.touched"
                text="E-mail é obrigatório"
                severity="error">
            </p-message>

            <p-message 
                *ngIf="newContactEmail.hasError('email') && newContactEmail.touched"
                text="E-mail não tem um formato válido"
                severity="error">
            </p-message>
        </div>
    
        <div class="col-12 p-fluid">
            <label>Telefone</label>

            <p-inputMask 
                name="newContactTelephone" 
                [(ngModel)]="newContactInfo.telephone"
                mask="(99) 99999-999?9"
                #newContactTelephone="ngModel"
                [required]="true">
            </p-inputMask>

            <p-message 
                *ngIf="newContactTelephone.hasError('required') && newContactTelephone.touched"
                text="Telefone é obrigatório"
                severity="error">
            </p-message>
        </div>
    
        <div class="col-12">
            <button 
                label="Confirmar" 
                pButton 
                type="submit" 
                [disabled]="formContact.invalid">
            </button>
        </div>
    </form>
</p-dialog>